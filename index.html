<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" />
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<script src="https://unpkg.com/vue/dist/vue.js"></script>
	<script src="util.js"></script>
    <title>Sweet Home Clock</title>
</head>
<body>
	<script>
		setInterval(()=>EventBus.$emit('SEC', new Date()), 1000);
	</script>


	<!-- clock start-->
	<script type="text/x-template" id="clock">
		<div>
			<div>
				{{date}} {{time}}
			</div>

		</div>
	</script>
	<script>
        Vue.component('clock', {
            template: '#clock',
            data(){
                return { now: new Date() };
            },
			computed: {
                date: {
                    get() {
                        var month = '' + (this.now.getMonth() + 1);
                        var day = '' + this.now.getDate();
                        var year = this.now.getFullYear();

                        if (month.length < 2) month = '0' + month;
                        if (day.length < 2) day = '0' + day;

                        return [year, month, day].join('-');
                    }
				},
				time: {
                    get() {
                        var h = '' + this.now.getHours();
                        var m = '' + this.now.getMinutes();
                        var s = '' + this.now.getSeconds();

                        if (h.length < 2) h = '0' + h;
                        if (m.length < 2) m = '0' + m;
                        if (s.length < 2) s = '0' + s;

                        return [h, m, s].join(':');
                    }
				}
			},
            mounted() {
                EventBus.$on("SEC", (now)=>{
                    this.now = now;
                })
            }
        });
	</script>
	<!-- clock end-->

	<!-- mission start-->
	<script type="text/x-template" id="mission">
		<tr>
			<td>{{m.stations[1].name}}</td>
			<td>{{m.stationsMessages[0]}}</td>
			<td>{{timeToWait}}</td>
		</tr>
	</script>
	<script>
        Vue.component('mission', {
            template: '#mission',
            props: ['m'],
			data(){
				return { now: new Date() };
			},
			computed: {
                timeToWait() {
                    if (!this.m.stationsStops[0]) return "";
                    let strArriveAt = this.m.stationsDates[0]
                    let y = strArriveAt.substr(0,4),
                        mo = strArriveAt.substr(4,2) - 1,
                        d = strArriveAt.substr(6,2),
                    	h = strArriveAt.substr(8,2),
                    	mi = strArriveAt.substr(10,2);
                    let arriveAt = new Date(y,mo,d,h,mi);
                    //if the date is valid
                    if (arriveAt.getFullYear() == y && arriveAt.getMonth() == mo && arriveAt.getDate() == d
						&& arriveAt.getHours()==h && arriveAt.getMinutes()==mi)
					{
						return Math.floor((arriveAt.getTime() - this.now.getTime()) / 60000);
					}
         																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																															return 'invalid date '+strArriveAt;
				}
			},
			mounted() {
                EventBus.$on("SEC", (now)=>{
                    this.now = now;
				})
			}
        });
	</script>
	<!-- mission end-->

	<!-- missionList start-->
	<script type="text/x-template" id="missionList">
		<div>
			<table border="1">
				<tr>Aller</tr>
				<tr is="mission" v-for="m in missions" v-if="m.direction.sens=='A' && m.stationsStops=='true'" :m="m"></tr>
				<tr>Retour</tr>
				<tr is="mission" v-for="m in missions" v-if="m.direction.sens=='R' && m.stationsStops=='true'" :m="m"></tr>
			</table>
		</div>
	</script>
	<script>
        Vue.component('missionList', {
            template: '#missionList',
            data() {
                return MISSON_NEXT_SAMPLE.return;
            }

        });
	</script>
	<!-- missionList end-->

	<!-- root start -->
	<script type="text/x-template" id="root">
		<div>
			<clock></clock>
			<missionList></missionList>
		</div>
	</script>
	<script>
        Vue.component('root', {
            template: '#root',
        });
	</script>
	<!-- root end -->


	<script src="mission_next_sample.js"></script>

	<div id='app'>
		<root></root>
	</div>
	<script>
        new Vue({
            el:'#app'
        });

        // axios.get('./api/getMissionsNext')
        //     .then(function (response) {
        //         //response.data.return.mission
        //         console.info(response);
        //     })
        //     .catch(function (error) {
        //         console.error(error);
        //     });
	</script>


</body>
</html>